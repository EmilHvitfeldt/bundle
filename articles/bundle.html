<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="bundle">
<title>Getting started with bundle • bundle</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.2/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.2/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with bundle">
<meta property="og:description" content="bundle">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">bundle</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9200</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/bundle.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rstudio/bundle/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Getting started with bundle</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/bundle/blob/HEAD/vignettes/bundle.Rmd" class="external-link"><code>vignettes/bundle.Rmd</code></a></small>
      <div class="d-none name"><code>bundle.Rmd</code></div>
    </div>

    
    
<p>R holds most objects in memory. However, some model objects store their data in locations that are not included when one uses <code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code> or <code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code>. bundle provides a common API to capture this information, situate it within a portable object, and restore it for use in new settings.</p>
<p>This vignette will walk through preparing a statistical model to be saved to demonstrate the benefits of using bundle.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/bundle" class="external-link">bundle</a></span><span class="op">)</span></span></code></pre></div>
<p>In addition to the package itself, we’ll load the keras and xgboost packages to fit some example models, and the callr package to generate fresh R sessions to test our models inside of.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com" class="external-link">keras</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost" class="external-link">xgboost</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://callr.r-lib.org" class="external-link">callr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="saving-things-is-hard">Saving things is hard<a class="anchor" aria-label="anchor" href="#saving-things-is-hard"></a>
</h2>
<p>As an example, let’s fit a model with the keras package, building a neural network that models miles per gallon using the rest of the variables in the built-in <code>mtcars</code> dataset.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cars</span> <span class="op">&lt;-</span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x_train</span> <span class="op">&lt;-</span> <span class="va">cars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span>, <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cars</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">cars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">25</span>, <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">x_test</span> <span class="op">&lt;-</span> <span class="va">cars</span><span class="op">[</span><span class="fl">26</span><span class="op">:</span><span class="fl">32</span>, <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cars</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">cars</span><span class="op">[</span><span class="fl">26</span><span class="op">:</span><span class="fl">32</span>, <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">keras_fit</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/keras_model_sequential.html" class="external-link">keras_model_sequential</a></span><span class="op">(</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/keras/man/layer_dense.html" class="external-link">layer_dense</a></span><span class="op">(</span>units <span class="op">=</span> <span class="fl">1</span>, input_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">x_train</span><span class="op">)</span>, activation <span class="op">=</span> <span class="st">'linear'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html" class="external-link">compile</a></span><span class="op">(</span></span>
<span>    loss <span class="op">=</span> <span class="st">'mean_squared_error'</span>,</span>
<span>    optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/optimizer_adam.html" class="external-link">optimizer_adam</a></span><span class="op">(</span>learning_rate <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="co">#&gt; Loaded Tensorflow version 2.4.0</span></span>
<span></span>
<span><span class="va">keras_fit</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">x_train</span>, y <span class="op">=</span> <span class="va">y_train</span>,</span>
<span>    epochs <span class="op">=</span> <span class="fl">100</span>, batch_size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    verbose <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Easy peasy! Now, given that this model is trained, we assume that it’s ready to go to predict on new data. Our mental map might look something like this:</p>
<p><img src="figures/diagram_01.png" title="A diagram showing a rectangle, labeled model object, and another rectangle, labeled predictions. The two are connected by an arrow from model object to predictions, with the label predict." alt="A diagram showing a rectangle, labeled model object, and another rectangle, labeled predictions. The two are connected by an arrow from model object to predictions, with the label predict." width="100%"></p>
<p>We pass a model object to the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> function, along with some new data to predict on, and get predictions back. Let’s try that out:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">keras_fit</span>, <span class="va">x_test</span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]</span></span>
<span><span class="co">#&gt; [1,]  1.5847281</span></span>
<span><span class="co">#&gt; [2,]  1.5928395</span></span>
<span><span class="co">#&gt; [3,]  1.2733133</span></span>
<span><span class="co">#&gt; [4,]  0.8232944</span></span>
<span><span class="co">#&gt; [5,] -0.5132220</span></span>
<span><span class="co">#&gt; [6,] -1.3140255</span></span>
<span><span class="co">#&gt; [7,]  1.0035419</span></span></code></pre></div>
<p>Perfect.</p>
<p>If we’re satisfied with this model and think it provides some valuable insights, we might want to deploy it somewhere—maybe on a Shiny app—so that others can make use of it.</p>
<p>The callr package will be helpful for emulating this kind of situation. The package allows us to start up a fresh R session and pass a few objects in.</p>
<p>We’ll just make use of two of the arguments to the function <code><a href="https://callr.r-lib.org/reference/r.html" class="external-link">r()</a></code>:</p>
<ul>
<li>
<code>func</code>: A function that, given a model object and some new data, will generate predictions, and</li>
<li>
<code>args</code>: A named list, giving the arguments to the above function.</li>
</ul>
<p>As an example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://callr.r-lib.org/reference/r.html" class="external-link">r</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">*</span> <span class="fl">2</span></span>
<span>  <span class="op">}</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
<p>So, our approach might be:</p>
<ul>
<li>save our model object</li>
<li>start up a new R session</li>
<li>load the model object into the new session</li>
<li>predict on new data with the loaded model object</li>
</ul>
<p>First, saving our model object to file:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">keras_fit</span>, file <span class="op">=</span> <span class="va">temp_file</span><span class="op">)</span></span></code></pre></div>
<p>Now, starting up a fresh R session and predicting on new data:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://callr.r-lib.org/reference/r.html" class="external-link">r</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">temp_file</span>, <span class="va">new_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com" class="external-link">keras</a></span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">model_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">temp_file</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model_object</span>, <span class="va">new_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    temp_file <span class="op">=</span> <span class="va">temp_file</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">x_test</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: <span style="color: #BBBB00;">!</span> error in callr subprocess</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error</span> in `do.call(object$predict, args)`:</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> 'what' must be a function or character string</span></span></code></pre></div>
<p>Oof. Hm.</p>
<p>After a bit of poking around in keras’ documentation, you might come across the keras vignette “Saving and serializing models” at <code><a href="https://cran.rstudio.com/web/packages/keras/vignettes/saving_serializing.html" class="external-link">vignette("saving_serializing", package = "keras")</a></code>. That vignette points us to several functions <em>in the keras package</em> that will allow us to save our model fit in a way that allows it to predict in a new session.</p>
<p>Given this new understanding, we can update our mental map a bit. Some objects require extra information when they’re loaded into new environments in order to do their thing. In this case, this keras model object needs access to additional references in order to predict on new data.</p>
<p><img src="figures/diagram_02.png" title="A diagram showing the same pair of rectangles as before, connected by the arrow labeled predict. This time, though, we introduce two boxes labeled reference. These two boxes are connected to the arrow labeled predict with dotted arrows, to show that, most of the time, we don't need to think about including them in our workflow." alt="A diagram showing the same pair of rectangles as before, connected by the arrow labeled predict. This time, though, we introduce two boxes labeled reference. These two boxes are connected to the arrow labeled predict with dotted arrows, to show that, most of the time, we don't need to think about including them in our workflow." width="100%"></p>
<p>In computer science, these bits of “extra information” are called <em>references</em>. Those references need to persist—or be restored—in new environments in order for the objects that reference them to work well.</p>
<p>These kinds of custom methods to save objects, like the ones that keras provide, are often referred to as <em>native serialization</em>. Methods for native serialization know which references need to be brought along in order for an object to effectively do its thing in a new environment.</p>
<p>Let’s make use of native serialization, then!</p>
</div>
<div class="section level2">
<h2 id="native-serialization-and-where-it-falls-short">Native serialization, and where it falls short<a class="anchor" aria-label="anchor" href="#native-serialization-and-where-it-falls-short"></a>
</h2>
<p>keras’ vignette is really informative in telling us what we ought to do from here—if we save the model with their native serialization rather than <code>saveRDS</code>, we’ll be good to go.</p>
<p>Saving our model object with their methods:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/save_model_tf.html" class="external-link">save_model_tf</a></span><span class="op">(</span><span class="va">keras_fit</span>, filepath <span class="op">=</span> <span class="va">temp_dir</span><span class="op">)</span></span></code></pre></div>
<p>Now, starting up a fresh R session and predicting on new data:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://callr.r-lib.org/reference/r.html" class="external-link">r</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">temp_dir</span>, <span class="va">new_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://keras.rstudio.com" class="external-link">keras</a></span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">model_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/keras/man/save_model_tf.html" class="external-link">load_model_tf</a></span><span class="op">(</span>filepath <span class="op">=</span> <span class="va">temp_dir</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model_object</span>, <span class="va">new_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    temp_dir <span class="op">=</span> <span class="va">temp_dir</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">x_test</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]</span></span>
<span><span class="co">#&gt; [1,]  1.5847281</span></span>
<span><span class="co">#&gt; [2,]  1.5928395</span></span>
<span><span class="co">#&gt; [3,]  1.2733133</span></span>
<span><span class="co">#&gt; [4,]  0.8232944</span></span>
<span><span class="co">#&gt; [5,] -0.5132220</span></span>
<span><span class="co">#&gt; [6,] -1.3140255</span></span>
<span><span class="co">#&gt; [7,]  1.0035419</span></span></code></pre></div>
<p>Awesome! Making use of their methods, we were able to effectively save our model, load it in a new R session, and predict on new data.</p>
<p>Now, a new scenario—I’ve heard that xgboost models are super performant, and want to try to productionize those, too. How would we do that?</p>
<p>Based on our workflow just now, we could try to just save it with <code>saveRDS</code> and see if we get an informative error somewhere along the way to predicting in a new R session. Or, maybe a better approach would be to read through their documentation and see if we can find anything related to serialization.</p>
<p>We’ve done the work of figuring that out, and it turns out the interface is a little bit different. You’ll need to make sure the <code>params</code> object persists across sessions, but <code>saveRDS</code> will work by itself if… ah, I’ll stop myself there.</p>
<p>What if we could just use the same function for any R object, and it would <em>just work</em>?</p>
<p><img src="figures/diagram_03.png" title="A diagram showing the same set of rectangles, representing a prediction problem, as before. This version of the diagram adds two boxes, labeled R Session numbe r one, and R session number two. In R session number two, we have a new rectangle labeled standalone model object. In focus is the arrow from the model object, in R Session number one, to the standalone model object in R session number two." alt="A diagram showing the same set of rectangles, representing a prediction problem, as before. This version of the diagram adds two boxes, labeled R Session numbe r one, and R session number two. In R session number two, we have a new rectangle labeled standalone model object. In focus is the arrow from the model object, in R Session number one, to the standalone model object in R session number two." width="100%"></p>
</div>
<div class="section level2">
<h2 id="using-bundle">Using bundle<a class="anchor" aria-label="anchor" href="#using-bundle"></a>
</h2>
<p>bundle provides a consistent interface to prepare R model objects to be saved and re-loaded. The package provides two functions—<code><a href="../reference/bundle.html">bundle()</a></code> and <code><a href="../reference/bundle.html">unbundle()</a></code>—that take care of all of the minutae of preparing to save and load R objects effectively.</p>
<p><img src="figures/diagram_04.png" title="A replica of the previous diagram, where the arrow previously connecting the model object in R session one and the standalone model object in R session two is connected by a verb called bundle. The bundle function outputs an object called a bundle." alt="A replica of the previous diagram, where the arrow previously connecting the model object in R session one and the standalone model object in R session two is connected by a verb called bundle. The bundle function outputs an object called a bundle." width="100%"></p>
<p>Bundles are just lists with two elements:</p>
<ul>
<li>
<code>object</code>: The <code>object</code> element of a bundle is the serialized version of the inputted model object. In the simplest situations in modeling, this object is just the output of a native serialization function like <code>saveRDS.lgb.Booster</code> that we used earlier.</li>
<li>
<code>situate()</code>: The <code>situate()</code> element of a bundle is a function that <em>situates</em> the <code>object</code> element in its new environment. It takes in the <code>object</code> element as input, but also “freezes” reference that existed when the original object was created.</li>
</ul>
<p>When <code><a href="../reference/bundle.html">unbundle()</a></code> is called on a bundle object, the <code>situate()</code> element of the bundle will re-load the <code>object</code> element and restore needed references in the new environment. Thus, the output of <code><a href="../reference/bundle.html">unbundle()</a></code> is ready to go for prediction wherever it is called.</p>
<p>To be a bit more concrete, lets return to the keras example. Bundling the model fit:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keras_bundle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bundle.html">bundle</a></span><span class="op">(</span><span class="va">keras_fit</span><span class="op">)</span></span></code></pre></div>
<p>Now, starting up a fresh R session and predicting on new data:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://callr.r-lib.org/reference/r.html" class="external-link">r</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">model_bundle</span>, <span class="va">new_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/bundle" class="external-link">bundle</a></span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">model_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bundle.html">unbundle</a></span><span class="op">(</span><span class="va">model_bundle</span><span class="op">)</span></span>
<span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model_object</span>, <span class="va">new_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    model_bundle <span class="op">=</span> <span class="va">keras_bundle</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">x_test</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;            [,1]</span></span>
<span><span class="co">#&gt; [1,]  1.5847281</span></span>
<span><span class="co">#&gt; [2,]  1.5928395</span></span>
<span><span class="co">#&gt; [3,]  1.2733133</span></span>
<span><span class="co">#&gt; [4,]  0.8232944</span></span>
<span><span class="co">#&gt; [5,] -0.5132220</span></span>
<span><span class="co">#&gt; [6,] -1.3140255</span></span>
<span><span class="co">#&gt; [7,]  1.0035419</span></span></code></pre></div>
<p>Huzzah!</p>
<p>The best part is, if you wanted to do the same thing for an xgboost object, you could use the same code!</p>
<p>First, fitting a quick xgboost model:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xgb_fit</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.train.html" class="external-link">xgboost</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">x_train</span>, </span>
<span>    label <span class="op">=</span> <span class="va">y_train</span>,</span>
<span>    nrounds <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; [1]  train-rmse:0.875983 </span></span>
<span><span class="co">#&gt; [2]  train-rmse:0.672900 </span></span>
<span><span class="co">#&gt; [3]  train-rmse:0.527715 </span></span>
<span><span class="co">#&gt; [4]  train-rmse:0.417273 </span></span>
<span><span class="co">#&gt; [5]  train-rmse:0.334283</span></span></code></pre></div>
<p>Now, bundling it:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xgb_bundle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bundle.html">bundle</a></span><span class="op">(</span><span class="va">xgb_fit</span><span class="op">)</span></span></code></pre></div>
<p>Now, starting up a fresh R session and predicting on new data:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://callr.r-lib.org/reference/r.html" class="external-link">r</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">model_bundle</span>, <span class="va">new_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/bundle" class="external-link">bundle</a></span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">model_object</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bundle.html">unbundle</a></span><span class="op">(</span><span class="va">model_bundle</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model_object</span>, <span class="va">new_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    model_bundle <span class="op">=</span> <span class="va">xgb_bundle</span>,</span>
<span>    new_data <span class="op">=</span> <span class="va">x_test</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  1.60800147  0.46607706  0.29694021 -0.05833863  0.24531488</span></span>
<span><span class="co">#&gt; [6] -0.76071244  0.29694021</span></span></code></pre></div>
<p>Voilà! We hope bundles are helpful in making your modeling and deployment workflows a good bit smoother in the future.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://juliasilge.com/" class="external-link">Julia Silge</a>, Simon Couch, Qiushi Yan, <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

  </div></footer>
</body>
</html>
